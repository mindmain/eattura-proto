syntax = "proto3";

package eattura.sdi.v1;

import "buf/validate/validate.proto";
import "eattura/sdi/v1/common.proto";
import "eattura/sdi/v1/enums.proto";
import "eattura/sdi/v1/natura.proto";

// FatturaElettronicaBodyType
message FatturaElettronicaBody {
  DatiGenerali datiGenerali = 1 [(buf.validate.field).required = true];
  DatiBeniServizi datiBeniServizi = 2 [(buf.validate.field).required = true];
  optional DatiVeicoli datiVeicoli = 3;
  repeated DatiPagamento datiPagamento = 4;
  repeated Allegati allegati = 5;
}

// --- DatiGenerali ---

// DatiGeneraliType - Blocco relativo ai Dati Generali della Fattura Elettronica
message DatiGenerali {
  DatiGeneraliDocumento datiGeneraliDocumento = 1 [(buf.validate.field).required = true];
  repeated DatiDocumentiCorrelati datiOrdineAcquisto = 2;
  repeated DatiDocumentiCorrelati datiContratto = 3;
  repeated DatiDocumentiCorrelati datiConvenzione = 4;
  repeated DatiDocumentiCorrelati datiRicezione = 5;
  repeated DatiDocumentiCorrelati datiFattureCollegate = 6;
  repeated DatiSAL datiSAL = 7;
  repeated DatiDDT datiDDT = 8;
  optional DatiTrasporto datiTrasporto = 9;
  optional FatturaPrincipale fatturaPrincipale = 10;
}

// DatiGeneraliDocumentoType
message DatiGeneraliDocumento {
  TipoDocumento tipoDocumento = 1 [(buf.validate.field).required = true];
  string divisa = 2 [(buf.validate.field).string = {pattern: "^[A-Z]{3}$"}];                                // DivisaType
  string data = 3 [(buf.validate.field).string.min_len = 1];                                                 // DataFatturaType (xs:date >= 1970-01-01)
  string numero = 4 [(buf.validate.field).string = {min_len: 1, max_len: 20}];                               // String20Type
  repeated DatiRitenuta datiRitenuta = 5;
  optional DatiBollo datiBollo = 6;
  repeated DatiCassaPrevidenziale datiCassaPrevidenziale = 7;
  repeated ScontoMaggiorazione scontoMaggiorazione = 8;
  optional double importoTotaleDocumento = 9;  // Amount2DecimalType
  optional double arrotondamento = 10;         // Amount2DecimalType
  repeated string causale = 11 [(buf.validate.field).repeated.items.string = {min_len: 1, max_len: 200}];   // String200LatinType
  optional Art73 art73 = 12;
}

// DatiRitenutaType
message DatiRitenuta {
  TipoRitenuta tipoRitenuta = 1 [(buf.validate.field).required = true];
  double importoRitenuta = 2;                                                   // Amount2DecimalType
  double aliquotaRitenuta = 3 [(buf.validate.field).double = {gte: 0, lte: 100}]; // RateType
  CausalePagamento causalePagamento = 4 [(buf.validate.field).required = true];
}

// DatiBolloType
message DatiBollo {
  BolloVirtuale bolloVirtuale = 1 [(buf.validate.field).required = true];
  optional double importoBollo = 2; // Amount2DecimalType
}

// DatiCassaPrevidenzialeType
message DatiCassaPrevidenziale {
  TipoCassa tipoCassa = 1 [(buf.validate.field).required = true];
  double alCassa = 2 [(buf.validate.field).double = {gte: 0, lte: 100}];          // RateType
  double importoContributoCassa = 3;                                                // Amount2DecimalType
  optional double imponibileCassa = 4;                                              // Amount2DecimalType
  double aliquotaIVA = 5 [(buf.validate.field).double = {gte: 0, lte: 100}];      // RateType
  optional Ritenuta ritenuta = 6;
  optional Natura natura = 7;
  optional string riferimentoAmministrazione = 8 [(buf.validate.field).string = {min_len: 1, max_len: 20}]; // String20Type
}

// DatiDocumentiCorrelatiType - usato per OrdineAcquisto, Contratto, Convenzione, Ricezione, FattureCollegate
message DatiDocumentiCorrelati {
  repeated int32 riferimentoNumeroLinea = 1 [(buf.validate.field).repeated.items.int32 = {gte: 1, lte: 9999}]; // RiferimentoNumeroLineaType
  string idDocumento = 2 [(buf.validate.field).string = {min_len: 1, max_len: 20}];                            // String20Type
  optional string data = 3;                                                                                      // xs:date
  optional string numItem = 4 [(buf.validate.field).string = {min_len: 1, max_len: 20}];                        // String20Type
  optional string codiceCommessaConvenzione = 5 [(buf.validate.field).string = {min_len: 1, max_len: 100}];     // String100LatinType
  optional string codiceCUP = 6 [(buf.validate.field).string = {min_len: 1, max_len: 15}];                      // String15Type
  optional string codiceCIG = 7 [(buf.validate.field).string = {min_len: 1, max_len: 15}];                      // String15Type
}

// DatiSALType - Stato Avanzamento Lavori
message DatiSAL {
  int32 riferimentoFase = 1 [(buf.validate.field).int32 = {gte: 1, lte: 999}]; // RiferimentoFaseType
}

// DatiDDTType - Documento di Trasporto
message DatiDDT {
  string numeroDDT = 1 [(buf.validate.field).string = {min_len: 1, max_len: 20}];                                // String20Type
  string dataDDT = 2 [(buf.validate.field).string.min_len = 1];                                                   // xs:date
  repeated int32 riferimentoNumeroLinea = 3 [(buf.validate.field).repeated.items.int32 = {gte: 1, lte: 9999}];   // RiferimentoNumeroLineaType
}

// DatiTrasportoType
message DatiTrasporto {
  optional DatiAnagraficiVettore datiAnagraficiVettore = 1;
  optional string mezzoTrasporto = 2 [(buf.validate.field).string = {min_len: 1, max_len: 80}];     // String80LatinType
  optional string causaleTrasporto = 3 [(buf.validate.field).string = {min_len: 1, max_len: 100}];  // String100LatinType
  optional int32 numeroColli = 4 [(buf.validate.field).int32 = {gte: 1, lte: 9999}];                // NumeroColliType
  optional string descrizione = 5 [(buf.validate.field).string = {min_len: 1, max_len: 100}];       // String100LatinType
  optional string unitaMisuraPeso = 6 [(buf.validate.field).string = {min_len: 1, max_len: 10}];    // String10Type
  optional double pesoLordo = 7 [(buf.validate.field).double.gte = 0];                               // PesoType
  optional double pesoNetto = 8 [(buf.validate.field).double.gte = 0];                               // PesoType
  optional string dataOraRitiro = 9;                                                                  // xs:dateTime
  optional string dataInizioTrasporto = 10;                                                           // xs:date
  optional string tipoResa = 11 [(buf.validate.field).string = {pattern: "^[A-Z]{3}$"}];            // TipoResaType
  optional Indirizzo indirizzoResa = 12;
  optional string dataOraConsegna = 13;                                                               // xs:dateTime
}

// DatiAnagraficiVettoreType
message DatiAnagraficiVettore {
  IdFiscale idFiscaleIVA = 1 [(buf.validate.field).required = true];
  optional string codiceFiscale = 2 [(buf.validate.field).string = {pattern: "^[A-Z0-9]{11,16}$"}]; // CodiceFiscaleType
  Anagrafica anagrafica = 3 [(buf.validate.field).required = true];
  optional string numeroLicenzaGuida = 4 [(buf.validate.field).string = {min_len: 1, max_len: 20}]; // String20Type
}

// FatturaPrincipaleType
message FatturaPrincipale {
  string numeroFatturaPrincipale = 1 [(buf.validate.field).string = {min_len: 1, max_len: 20}]; // String20Type
  string dataFatturaPrincipale = 2 [(buf.validate.field).string.min_len = 1];                    // xs:date
}

// --- DatiBeniServizi ---

// DatiBeniServiziType - Blocco relativo ai dati di Beni Servizi della Fattura Elettronica
message DatiBeniServizi {
  repeated DettaglioLinee dettaglioLinee = 1 [(buf.validate.field).repeated.min_items = 1];
  repeated DatiRiepilogo datiRiepilogo = 2 [(buf.validate.field).repeated.min_items = 1];
}

// DettaglioLineeType
message DettaglioLinee {
  int32 numeroLinea = 1 [(buf.validate.field).int32 = {gte: 1, lte: 9999}];                        // NumeroLineaType
  optional TipoCessionePrestazione tipoCessionePrestazione = 2;
  repeated CodiceArticolo codiceArticolo = 3;
  string descrizione = 4 [(buf.validate.field).string = {min_len: 1, max_len: 1000}];              // String1000LatinType
  optional double quantita = 5;                                                                      // QuantitaType
  optional string unitaMisura = 6 [(buf.validate.field).string = {min_len: 1, max_len: 10}];       // String10Type
  optional string dataInizioPeriodo = 7;                                                              // xs:date
  optional string dataFinePeriodo = 8;                                                                // xs:date
  double prezzoUnitario = 9;                                                                          // Amount8DecimalType
  repeated ScontoMaggiorazione scontoMaggiorazione = 10;
  double prezzoTotale = 11;                                                                           // Amount8DecimalType
  double aliquotaIVA = 12 [(buf.validate.field).double = {gte: 0, lte: 100}];                       // RateType
  optional Ritenuta ritenuta = 13;
  optional Natura natura = 14;
  optional string riferimentoAmministrazione = 15 [(buf.validate.field).string = {min_len: 1, max_len: 20}]; // String20Type
  repeated AltriDatiGestionali altriDatiGestionali = 16;
}

// DatiRiepilogoType
message DatiRiepilogo {
  double aliquotaIVA = 1 [(buf.validate.field).double = {gte: 0, lte: 100}]; // RateType
  optional Natura natura = 2;
  optional double speseAccessorie = 3;  // Amount2DecimalType
  optional double arrotondamento = 4;   // Amount8DecimalType
  double imponibileImporto = 5;         // Amount2DecimalType
  double imposta = 6;                   // Amount2DecimalType
  optional EsigibilitaIVA esigibilitaIVA = 7;
  optional string riferimentoNormativo = 8 [(buf.validate.field).string = {min_len: 1, max_len: 100}]; // String100LatinType
}

// --- DatiVeicoli ---

// DatiVeicoliType - Blocco relativo ai dati dei Veicoli (cessioni tra Paesi membri di mezzi di trasporto nuovi)
message DatiVeicoli {
  string data = 1 [(buf.validate.field).string.min_len = 1];                               // xs:date
  string totalePercorso = 2 [(buf.validate.field).string = {min_len: 1, max_len: 15}];    // String15Type
}

// --- DatiPagamento ---

// DatiPagamentoType - Blocco relativo ai dati di Pagamento della Fattura Elettronica
message DatiPagamento {
  CondizioniPagamento condizioniPagamento = 1 [(buf.validate.field).required = true];
  repeated DettaglioPagamento dettaglioPagamento = 2 [(buf.validate.field).repeated.min_items = 1];
}

// DettaglioPagamentoType
message DettaglioPagamento {
  optional string beneficiario = 1 [(buf.validate.field).string = {min_len: 1, max_len: 200}];              // String200LatinType
  ModalitaPagamento modalitaPagamento = 2 [(buf.validate.field).required = true];
  optional string dataRiferimentoTerminiPagamento = 3;                                                        // xs:date
  optional int32 giorniTerminiPagamento = 4 [(buf.validate.field).int32 = {gte: 0, lte: 999}];              // GiorniTerminePagamentoType
  optional string dataScadenzaPagamento = 5;                                                                  // xs:date
  double importoPagamento = 6;                                                                                // Amount2DecimalType
  optional string codUfficioPostale = 7 [(buf.validate.field).string = {min_len: 1, max_len: 20}];          // String20Type
  optional string cognomeQuietanzante = 8 [(buf.validate.field).string = {min_len: 1, max_len: 60}];        // String60LatinType
  optional string nomeQuietanzante = 9 [(buf.validate.field).string = {min_len: 1, max_len: 60}];           // String60LatinType
  optional string CFQuietanzante = 10 [(buf.validate.field).string = {pattern: "^[A-Z0-9]{16}$"}];          // CodiceFiscalePFType
  optional string titoloQuietanzante = 11 [(buf.validate.field).string = {min_len: 2, max_len: 10}];        // TitoloType
  optional string istitutoFinanziario = 12 [(buf.validate.field).string = {min_len: 1, max_len: 80}];       // String80LatinType
  optional string IBAN = 13 [(buf.validate.field).string = {pattern: "^[a-zA-Z]{2}[0-9]{2}[a-zA-Z0-9]{11,30}$"}]; // IBANType
  optional string ABI = 14 [(buf.validate.field).string = {pattern: "^[0-9]{5}$"}];                          // ABIType
  optional string CAB = 15 [(buf.validate.field).string = {pattern: "^[0-9]{5}$"}];                          // CABType
  optional string BIC = 16 [(buf.validate.field).string = {pattern: "^[A-Z]{6}[A-Z2-9][A-NP-Z0-9]([A-Z0-9]{3})?$"}]; // BICType
  optional double scontoPagamentoAnticipato = 17;                                                             // Amount2DecimalType
  optional string dataLimitePagamentoAnticipato = 18;                                                         // xs:date
  optional double penalitaPagamentiRitardati = 19;                                                            // Amount2DecimalType
  optional string dataDecorrenzaPenale = 20;                                                                  // xs:date
  optional string codicePagamento = 21 [(buf.validate.field).string = {min_len: 1, max_len: 60}];           // String60Type
}

// --- Allegati ---

// AllegatiType - Blocco relativo ai dati di eventuali allegati
message Allegati {
  string nomeAttachment = 1 [(buf.validate.field).string = {min_len: 1, max_len: 60}];              // String60LatinType
  optional string algoritmoCompressione = 2 [(buf.validate.field).string = {min_len: 1, max_len: 10}]; // String10Type
  optional string formatoAttachment = 3 [(buf.validate.field).string = {min_len: 1, max_len: 10}];     // String10Type
  optional string descrizioneAttachment = 4 [(buf.validate.field).string = {min_len: 1, max_len: 100}]; // String100LatinType
  bytes attachment = 5 [(buf.validate.field).bytes.min_len = 1];                                         // xs:base64Binary
}
